const GSCRIPT_URL="https://script.google.com/macros/s/TU_ID_AQUI/exec";const views=document.querySelectorAll(".view");const navBtns=document.querySelectorAll(".nav-btn");const tblEphemeris=document.getElementById("tblEphemeris");const frmCalc=document.getElementById("frmCalc");const inpDistSun=document.getElementById("inpDistSun");const inpDistEarth=document.getElementById("inpDistEarth");const calcResult=document.getElementById("calcResult");const frmLog=document.getElementById("frmLog");const tblLogs=document.querySelector("#tblLogs tbody");const btnExportCSV=document.getElementById("btnExportCSV");const quizBox=document.getElementById("quizBox");const frmTicket=document.getElementById("frmTicket");const ticketMsg=document.getElementById("ticketMsg");const btnTheme=document.getElementById("btnTheme");const btnInstall=document.getElementById("btnInstall");const topbar=document.querySelector(".topbar");const chartCanvas=document.getElementById("chartMag");let logs=[];let deferredPrompt=null;let clickSound=null;async function getGeo(){return new Promise(r=>{if(!navigator.geolocation)return r({geo_ok:false});navigator.geolocation.getCurrentPosition(p=>r({geo_ok:true,lat:p.coords.latitude,lon:p.coords.longitude,acc:p.coords.accuracy}),()=>r({geo_ok:false}),{enableHighAccuracy:true,timeout:4000});});}function getUA(){return navigator.userAgent||"desconocido";}navBtns.forEach(btn=>{btn.addEventListener("click",()=>{const view=btn.dataset.view;navBtns.forEach(b=>b.classList.remove("active"));btn.classList.add("active");views.forEach(v=>v.classList.remove("visible"));document.getElementById(`view-${view}`).classList.add("visible");playClick();});});window.addEventListener("scroll",()=>{if(window.scrollY>20)topbar.classList.add("scrolled");else topbar.classList.remove("scrolled");});fetch("./data/ephemeris.json").then(r=>r.json()).then(d=>renderEphemeris(d)).catch(()=>renderEphemeris([{fecha:"2025-10-30",dist_sun:1.4,dist_earth:1.9,mag:13.1},{fecha:"2025-11-15",dist_sun:1.45,dist_earth:1.86,mag:13.3}]));function renderEphemeris(rows){if(!tblEphemeris)return;const head="<thead><tr><th>Fecha</th><th>Sol (UA)</th><th>Tierra (UA)</th><th>Mag</th></tr></thead>";const body=rows.map(r=>`<tr><td>${r.fecha}</td><td>${r.dist_sun}</td><td>${r.dist_earth}</td><td>${r.mag}</td></tr>`).join("");tblEphemeris.innerHTML=head+`<tbody>${body}</tbody>`;}frmCalc?.addEventListener("submit",e=>{e.preventDefault();const uaSun=parseFloat(inpDistSun.value);const uaEarth=parseFloat(inpDistEarth.value);const KM=149597870;calcResult.textContent=`ðŸŒž Sol: ${(uaSun*KM).toLocaleString("es-CL")} km | ðŸŒ Tierra: ${(uaEarth*KM).toLocaleString("es-CL")} km`;playClick();});frmLog?.addEventListener("submit",async e=>{e.preventDefault();const date=document.getElementById("logDate").value||new Date().toISOString().slice(0,10);const mag=document.getElementById("logMag").value||"-";const comment=document.getElementById("logComment").value||"";const item={id:logs.length+1,date,mag,comment};logs.push(item);renderLogs();frmLog.reset();playClick();const geo=await getGeo();const ua=getUA();const payload={tipo:"observacion",fecha:date,mag,comentario:comment,user:"Alumno/Docente",origen:"3i-atlas-web",ua:ua,geo_ok:geo.geo_ok,lat:geo.lat||null,lon:geo.lon||null,acc:geo.acc||null};try{await fetch(GSCRIPT_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});}catch(err){console.warn("no enviado",err);}});function renderLogs(){if(!tblLogs)return;tblLogs.innerHTML=logs.map(it=>`<tr><td>${it.id}</td><td>${it.date}</td><td>${it.mag}</td><td>${it.comment}</td></tr>`).join("");}btnExportCSV?.addEventListener("click",()=>{if(!logs.length)return;const header="id,fecha,mag,comentario\n";const rows=logs.map(l=>`${l.id},${l.date},${l.mag},"${l.comment.replace(/"/g,'""')}"`).join("\n");const blob=new Blob([header+rows],{type:"text/csv"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="observaciones-3i-atlas.csv";a.click();URL.revokeObjectURL(url);playClick();});if(quizBox){const qs=[{q:"Â¿QuÃ© tipo de objeto es 3I/ATLAS?",a:["Cometa interestelar","Asteroide","SatÃ©lite"],correct:0},{q:"Â¿En quÃ© aÃ±o se descubriÃ³?",a:["2025","2019","2030"],correct:0},{q:"Â¿QuÃ© significa la I?",a:["Interestelar","Interior","Inercial"],correct:0}];quizBox.innerHTML=qs.map((qu,i)=>`<div class='q'><p><strong>${i+1}.</strong> ${qu.q}</p>${qu.a.map((opt,j)=>`<label><input type='radio' name='q${i}' value='${j}'> ${opt}</label>`).join("")}</div>`).join("")+"<button id='btnQuizCheck' class='btn-primary micro'>Revisar</button><p id='quizMsg'></p>";quizBox.querySelector("#btnQuizCheck").addEventListener("click",()=>{let score=0;qs.forEach((qu,i)=>{const chk=quizBox.querySelector(`input[name='q${i}']:checked`);if(chk&&Number(chk.value)===qu.correct)score++;});quizBox.querySelector("#quizMsg").textContent=`Puntaje: ${score} / ${qs.length}`;playClick();});}frmTicket?.addEventListener("submit",async e=>{e.preventDefault();const q1=document.getElementById("t1").value.trim();const q2=document.getElementById("t2").value.trim();const q3=document.getElementById("t3").value.trim();ticketMsg.textContent="âœ… Ticket recibido. Guardando...";frmTicket.reset();playClick();const geo=await getGeo();const ua=getUA();const payload={tipo:"ticket",q1,q2,q3,user:"Alumno/PIE/Liceo San NicolÃ¡s",origen:"3i-atlas-web",ua,geo_ok:geo.geo_ok,lat:geo.lat||null,lon:geo.lon||null,acc:geo.acc||null};try{await fetch(GSCRIPT_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});ticketMsg.textContent="âœ… Ticket guardado y enviado al docente.";}catch(err){ticketMsg.textContent="âš ï¸ Ticket recibido pero no se pudo enviar al Sheets.";} });btnTheme?.addEventListener("click",()=>{document.body.classList.toggle("dark");playClick();});window.addEventListener("beforeinstallprompt",e=>{e.preventDefault();deferredPrompt=e;btnInstall.style.display="inline-flex";});btnInstall?.addEventListener("click",async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;playClick();});try{clickSound=new Audio("./assets/sounds/click.mp3");clickSound.volume=0.15;}catch(e){clickSound=null;}function playClick(){if(clickSound){clickSound.currentTime=0;clickSound.play().catch(()=>{});}if(navigator.vibrate)navigator.vibrate(20);}if(chartCanvas){const ctx=chartCanvas.getContext("2d");const base=[13.1,13.3,13.5,13.7];function draw(){ctx.clearRect(0,0,chartCanvas.width,chartCanvas.height);ctx.beginPath();ctx.moveTo(10,chartCanvas.height-base[0]*5);for(let i=1;i<base.length;i++){ctx.lineTo(10+i*100,chartCanvas.height-base[i]*5);}ctx.strokeStyle="#38bdf8";ctx.lineWidth=2;ctx.stroke();ctx.fillStyle="#38bdf8";for(let i=0;i<base.length;i++){ctx.beginPath();ctx.arc(10+i*100,chartCanvas.height-base[i]*5,4,0,Math.PI*2);ctx.fill();}requestAnimationFrame(draw);}draw();}